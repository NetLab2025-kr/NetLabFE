<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>질문 게시글 등록</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="../assets/css/add_question.css">
  <script src="/PUBLIC/JS/navbarAndToken.js"></script>

</head>
<body>
  <div class="navbar">
    <div class="welcome"><a href="/index.html">NetLab</a></div>
    <div style="display:flex; align-items:center;">
      <div id="nav-links"></div>
      <div id="user-info" style="display:none;"></div>
    </div>
  </div>

  <div class="container">
    <h1>게시글 등록</h1>

    <!-- 관리자만 노출 -->
    <div id="postTypeGroup" style="display:none;">
      <div class="post-type-btns">
        <label>
          <input type="radio" name="postType" value="question" checked />
          <span>일반 글</span>
        </label>
        <label>
          <input type="radio" name="postType" value="notice" />
          <span>공지사항</span>
        </label>
      </div>
    </div>

    <input type="text" id="title" placeholder="제목을 입력하세요.">
    <textarea id="content" placeholder="질문 내용을 입력하세요."></textarea>
    <button id="submitBtn">등록하기</button>
  </div>

  <script>
    $(function () {
      const API = 'https://be.netlab.kr/api';

      (function showNoticeIfAdmin() {
        const at = localStorage.getItem('token');
        if (!at) return; // 비로그인: 숨김 유지
        $.ajax({
          url: `${API}/auth/is-admin`,
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + at }
        }).done(function (res) {
          const isAdmin = (typeof res === 'boolean') ? res : !!(res && res.isAdmin);
          if (isAdmin) $('#postTypeGroup').show();
        }); 
      })();

      $('#submitBtn').on('click', function () {
        const title = $('#title').val().trim();
        const content = $('#content').val().trim();
        const postType = $('input[name="postType"]:checked').val();
        if (!title || !content) return alert('제목과 내용을 모두 입력해주세요.');

        const url = (postType === 'notice')
          ? `${API}/admin/notices`
          : `${API}/questions`;

        const at = localStorage.getItem('token');
        const headers = at ? { 'Authorization': 'Bearer ' + at } : {};

        $.ajax({
          url, method: 'POST',
          contentType: 'application/json',
          headers,
          data: JSON.stringify({ title, content })
        }).done(function () {
          alert(postType === 'notice' ? '공지사항이 등록되었습니다!' : '질문이 등록되었습니다!');
          location.href = '/community/community.html';
        }).fail(function (xhr) {
          if (xhr.status === 401) {
            // 여기서 따로 refresh 시도하지 않음 → 공통 로직에 위임
            alert('세션이 만료되었습니다. 다시 로그인해주세요.');
            location.href = '/login/login.html';
          } else {
            alert('등록에 실패했습니다.');
          }
        });
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>커뮤니티 - 질문 목록</title>

  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="../config.js"></script>

  <link rel="stylesheet" href="../assets/css/community.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <script src="/PUBLIC/JS/navbarAndToken.js"></script>
</head>

<body class="has-navbar">
  <div class="navbar">
    <a href="/index.html" class="brand">NetLab</a>
    <div class="right-group" style="display:flex;align-items:center;gap:18px;">
      <div id="nav-links"></div>
      <div class="user-info" id="user-info" style="display:none;"></div>
    </div>
  </div>

  <div class="container">
    <h1>커뮤니티</h1>
    <button class="ask-btn" onclick="location.href='/community/add_question.html'">글 등록하기</button>
    <ul class="question-list" id="questionList"></ul>
  </div>

  <div class="modal-bg" id="modalBg">
    <div class="modal-box">
      <button class="close-btn" id="closeModal" aria-label="닫기">&times;</button>
      <div id="modalInner"></div>
    </div>
  </div>

  <script>
    $(function () {
      const API = window.API_BASE_URL;

      /* ---------------- 네비/사용자 상태 ---------------- */
      const navEl = document.getElementById('nav-links');
      const userEl = document.getElementById('user-info');

      function getUserNameFromNav() {
        return (userEl && userEl.textContent) ? userEl.textContent.trim() : '';
      }

      async function getAdminFlag() {
        const at = localStorage.getItem('token');
        if (!at) return false;
        try {
          const res = await fetch(`${API}/auth/is-admin`, {
            headers: { 'Authorization': 'Bearer ' + at }
          });
          if (!res.ok) return false;
          const data = await res.json(); // boolean 또는 {isAdmin:true}
          return typeof data === 'boolean' ? data : !!data.isAdmin;
        } catch (e) { return false; }
      }

      // 네비가 동적으로 바뀌면 목록을 다시 그림(로그인/닉네임 표기 등)
      let navReadyTimer = null;
      const mo = new MutationObserver(() => {
        clearTimeout(navReadyTimer);
        navReadyTimer = setTimeout(() => loadQuestions(), 60);
      });
      if (navEl) mo.observe(navEl, { childList: true, subtree: true, characterData: true });

      /* ---------------- 유틸 ---------------- */
      const safeText = s => (s ?? '').toString();
      const fmtDate = ts => ts ? ts.replace('T', ' ').slice(0, 19) : '';

      /* ---------------- 목록 렌더 ---------------- */
      function renderItem($ul, q, canDelete) {
        const $li = $('<li>').attr('data-id', q.id);

        const titleText = (q.notice ? '[공지] ' : '') + safeText(q.title);
        const $ttl = $('<div>')
          .addClass('question-title' + (q.notice ? ' notice' : ''))
          .text(titleText)
          .css('color', q.notice ? '#FF3337' : '#2563eb');

        const meta = `작성자: ${safeText(q.author)} | 작성일: ${fmtDate(q.createdAt)}`;
        const $meta = $('<div>').addClass('question-meta').text(meta);

        if (canDelete) {
          const $del = $('<button>').addClass('delete-btn').attr('data-id', q.id).text('삭제');
          $meta.append(' ', $del);
        }

        $li.append($ttl, $meta);
        $ul.append($li);
      }

      async function loadQuestions() {
        try {
          const [isAdmin, res] = await Promise.all([
            getAdminFlag(),
            fetch(`${API}/questions`, {
              headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
              }
            }).then(r => r.json())]);

          const $list = $('#questionList').empty();
          if (!res || !res.length) {
            $list.append($('<li>').css({ textAlign: 'center', color: '#aaa' }).text('등록된 질문이 없습니다.'));
            return;
          }
          const currentName = getUserNameFromNav();

          // 최신 글 위로
          res.slice().reverse().forEach(q => {
            // 관리자면 무조건 삭제 가능, 아니면 본인 글만
            const canDelete = isAdmin || (!!currentName && q.author === currentName);
            renderItem($list, q, canDelete);
          });
        } catch (e) {
          alert('질문 목록 불러오기 실패');
        }
      }

      /* ---------------- 상세 모달 ---------------- */
      $(document).on('click', '.question-list li', function (e) {
        if ($(e.target).is('.delete-btn')) return;
        const id = $(this).data('id');

        $.ajax({
          url: `${API}/questions/${id}`,
          method: 'GET',
          dataType: 'json',
          success: function (q) {
            const $box = $('#modalInner').empty();
            const titleText = (q.notice ? '[공지] ' : '') + safeText(q.title);
            const $title = $('<div>').addClass('modal-title').text(titleText);
            if (q.notice) $title.css('color', '#FF3337');
            $box.append($title);

            const meta = `작성자: ${safeText(q.author)} | 작성일: ${fmtDate(q.createdAt)}`;
            $('<div>').addClass('modal-meta').text(meta).appendTo($box);
            $('<div>').addClass('modal-content').text(safeText(q.content)).appendTo($box);

            $('#modalBg').css('display', 'flex');
          },
          error: () => alert('상세 조회 실패')
        });
      });

      // 모달 닫기
      $('#closeModal, #modalBg').on('click', function (e) {
        if (e.target === this) $('#modalBg').hide();
      });
      $('.modal-box').on('click', e => e.stopPropagation());

      /* ---------------- 삭제 ---------------- */
      $(document).on('click', '.delete-btn', function (e) {
        e.stopPropagation();
        const id = $(this).data('id');
        if (!confirm('정말 삭제할까요?')) return;

        const token = localStorage.getItem('token');
        if (!token) {
          alert('로그인이 필요합니다.');
          return location.href = '/login/login.html';
        }

        // 관리자 API 우선, 실패 시 일반 API로 재시도
        const adminUrl = `${API}/admin/questions/${id}`;
        const userUrl = `${API}/questions/${id}`;

        $.ajax({
          url: adminUrl,
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token },
          success: function () {
            alert('삭제되었습니다.');
            $('#modalBg').hide();
            loadQuestions();
          },
          error: function () {
            $.ajax({
              url: userUrl,
              method: 'DELETE',
              headers: { 'Authorization': 'Bearer ' + token },
              success: function () {
                alert('삭제되었습니다.');
                $('#modalBg').hide();
                loadQuestions();
              },
              error: function (xhr) {
                if (xhr.status === 401) {
                  alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                  localStorage.clear();
                  location.href = '/login/login.html';
                } else {
                  alert('삭제 실패');
                }
              }
            });
          }
        });
      });

      /* ---------------- 초기 로드 ---------------- */
      loadQuestions();
    });
  </script>
</body>

</html>
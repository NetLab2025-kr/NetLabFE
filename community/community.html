<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>커뮤니티 - 질문 목록</title>

  <!-- 폰트 / jQuery -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- 페이지 전용 CSS -->
  <link rel="stylesheet" href="../assets/css/community.css">
  <!-- 전역 네비바/공통 스타일 -->
  <link rel="stylesheet" href="../assets/css/style.css">

  <!-- 네비바 렌더/토큰 관리 -->
  <script src="/PUBLIC/JS/navbarAndToken.js"></script>
</head>
<body class="has-navbar">
  <!-- NAVBAR -->
  <div class="navbar">
    <a href="/index.html" class="brand">NetLab</a>
    <div class="right-group" style="display:flex;align-items:center;gap:18px;">
      <div id="nav-links"></div>
      <div class="user-info" id="user-info" style="display:none;"></div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="container">
    <h1>커뮤니티</h1>
    <button class="ask-btn" onclick="location.href='/community/add_question.html'">글 등록하기</button>
    <ul class="question-list" id="questionList"></ul>
  </div>

  <!-- MODAL -->
  <div class="modal-bg" id="modalBg">
    <div class="modal-box">
      <button class="close-btn" id="closeModal" aria-label="닫기">&times;</button>
      <div id="modalInner"></div>
    </div>
  </div>

  <script>
    $(function () {
      const API = 'https://be.netlab.kr/api';

      /* ---------------- 네비 상태 참조 ---------------- */
      const navEl  = document.getElementById('nav-links');
      const userEl = document.getElementById('user-info');

      function getIsAdminFromNav() {
        if (!navEl) return false;
        return Array.from(navEl.querySelectorAll('a'))
          .some(a => a.textContent && a.textContent.includes('관리자 메뉴'));
      }
      function getUserNameFromNav() {
        return (userEl && userEl.textContent) ? userEl.textContent.trim() : '';
      }

      // 네비가 동적으로 바뀔 수 있어 관찰만 연결(현재는 별도 처리 없음)
      const mo = new MutationObserver(() => {});
      if (navEl) mo.observe(navEl, { childList: true, subtree: true, characterData: true });

      /* ---------------- 유틸 ---------------- */
      const safeText = s => (s ?? '').toString();

      /* ---------------- 목록 렌더 ---------------- */
      function renderItem($ul, q, canEdit) {
        const $li  = $('<li>').attr('data-id', q.id);

        // 공지면 말머리 + 빨강, 아니면 기본 파랑
        const titleText = (q.notice ? '[공지] ' : '') + safeText(q.title);
        const $ttl = $('<div>')
          .addClass('question-title' + (q.notice ? ' notice' : ''))
          .text(titleText)
          .css('color', q.notice ? '#FF3337' : '#2563eb');

        const meta = `작성자: ${safeText(q.author)} | 작성일: ${q.createdAt ? q.createdAt.replace('T',' ').slice(0,19) : ''}`;
        const $meta = $('<div>').addClass('question-meta').text(meta);

        if (canEdit) {
          const $edit = $('<button>').addClass('edit-btn').attr('data-id', q.id).text('수정');
          const $del  = $('<button>').addClass('delete-btn').attr('data-id', q.id).text('삭제');
          $meta.append(' ', $edit, ' ', $del);
        }

        $li.append($ttl, $meta);
        $ul.append($li);
      }

      function loadQuestions() {
        $.ajax({
          url: `${API}/questions`,
          method: 'GET',
          dataType: 'json',
          success: function (res) {
            const $list = $('#questionList').empty();
            if (!res || res.length === 0) {
              $list.append($('<li>').css({textAlign:'center', color:'#aaa'}).text('등록된 질문이 없습니다.'));
              return;
            }
            const currentName = getUserNameFromNav();
            const isAdmin     = getIsAdminFromNav();

            // 최신 글 위로
            res.slice().reverse().forEach(q => {
              const canEdit = !!currentName && (isAdmin || q.author === currentName);
              renderItem($list, q, canEdit);
            });
          },
          error: () => alert('질문 목록 불러오기 실패')
        });
      }

      /* ---------------- 상세 모달 ---------------- */
      $(document).on('click', '.question-list li', function (e) {
        if ($(e.target).is('.edit-btn,.delete-btn')) return; // 버튼은 별도 처리
        const id = $(this).data('id');

        $.ajax({
          url: `${API}/questions/${id}`,
          method: 'GET',
          dataType: 'json',
          success: function (q) {
            const $box = $('#modalInner').empty();

            // 공지면 제목 앞에 [공지] 붙이고 빨간색
            const titleText = (q.notice ? '[공지] ' : '') + safeText(q.title);
            const $title = $('<div>').addClass('modal-title').text(titleText);
            if (q.notice) $title.css('color', '#FF3337');
            $box.append($title);

            const meta = `작성자: ${safeText(q.author)} | 작성일: ${q.createdAt ? q.createdAt.replace('T',' ').slice(0,19) : ''}`;
            $('<div>').addClass('modal-meta').text(meta).appendTo($box);

            $('<div>').addClass('modal-content').text(safeText(q.content)).appendTo($box);

            $('#modalBg').css('display', 'flex');
          },
          error: () => alert('상세 조회 실패')
        });
      });

      // 모달 닫기
      $('#closeModal, #modalBg').on('click', function (e) {
        if (e.target === this) $('#modalBg').hide();
      });
      $('.modal-box').on('click', e => e.stopPropagation());

      /* ---------------- 삭제 ---------------- */
      $(document).on('click', '.delete-btn', function (e) {
        e.stopPropagation();
        const id = $(this).data('id');
        if (!confirm('정말 삭제할까요?')) return;

        const isAdmin = getIsAdminFromNav();
        const token   = localStorage.getItem('token');
        if (!token) {
          alert('로그인이 필요합니다.');
          return location.href = '/login/login.html';
        }

        const url = isAdmin ? `${API}/admin/questions/${id}` : `${API}/questions/${id}`;

        $.ajax({
          url, method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token },
          success: function () {
            alert('삭제되었습니다.');
            $('#modalBg').hide();
            loadQuestions();
          },
          error: function (xhr) {
            if (xhr.status === 401) {
              alert('세션이 만료되었습니다. 다시 로그인해주세요.');
              localStorage.clear();
              location.href = '/login/login.html';
            } else {
              alert('삭제 실패');
            }
          }
        });
      });

      /* ---------------- 수정 ---------------- */
      $(document).on('click', '.edit-btn', function (e) {
        e.stopPropagation();
        const id = $(this).data('id');

        $.ajax({
          url: `${API}/questions/${id}`,
          method: 'GET',
          dataType: 'json',
          success: function (q) {
            const $box = $('#modalInner').empty();

            $('<input>')
              .attr({type:'text', id:'editTitle'})
              .addClass('modal-title-edit')
              .val(q.title || '')
              .appendTo($box);

            const meta = `작성자: ${safeText(q.author)} | 작성일: ${q.createdAt ? q.createdAt.replace('T',' ').slice(0,19) : ''}`;
            $('<div>').addClass('modal-meta').text(meta).appendTo($box);

            $('<textarea>')
              .attr('id','editContent')
              .addClass('modal-content-edit')
              .val(q.content || '')
              .appendTo($box);

            const $btns = $('<div>').addClass('modal-btn-group').appendTo($box);
            $('<button>').addClass('modal-btn-save').attr('id','saveEditBtn').text('저장').appendTo($btns);
            $('<button>').addClass('modal-btn-cancel').attr('id','cancelEditBtn').text('취소').appendTo($btns);

            $('#modalBg').css('display','flex');

            $('#cancelEditBtn').off('click').on('click', () => $('#modalBg').hide());
            $('#saveEditBtn').off('click').on('click', function () {
              const newTitle = $('#editTitle').val().trim();
              const newContent = $('#editContent').val().trim();
              if (!newTitle || !newContent) { alert('제목/내용을 입력하세요.'); return; }

              const token = localStorage.getItem('token');
              if (!token) {
                alert('로그인이 필요합니다.');
                return location.href = '/login/login.html';
              }

              $.ajax({
                url: `${API}/questions/${id}`,
                method: 'PUT',
                contentType: 'application/json',
                headers: { 'Authorization': 'Bearer ' + token },
                data: JSON.stringify({ title: newTitle, content: newContent }),
                success: function () {
                  alert('수정 완료!');
                  $('#modalBg').hide();
                  loadQuestions();
                },
                error: function (xhr) {
                  if (xhr.status === 401) {
                    alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                    localStorage.clear();
                    location.href = '/login/login.html';
                  } else {
                    alert('수정 실패');
                  }
                }
              });
            });
          },
          error: () => alert('글 정보를 불러오지 못했습니다.')
        });
      });

      /* ---------------- 초기 로드 ---------------- */
      loadQuestions();
    });
  </script>
</body>
</html>

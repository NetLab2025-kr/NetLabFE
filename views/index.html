<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NetLab</title>

  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="../config.js"></script>
  <script src="../PUBLIC/JS/navbarAndToken.js"></script>
  <!-- ✅ 폭죽 효과 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/problem_view.css">
</head>

<body>
  <div id="top-view">
    <div id="problem-box">
      <div id="problem-head">
        <h1 id="problem-title">문제 제목</h1>
        <button id="downloadBtn" class="btn">.pka 파일 다운로드</button>
        <h2 class="problem-level" id="problem-level">EASY</h2>
      </div>

      <div id="problem-content">로딩 중...</div>

      <div id="submit-box">
        <h3>플래그 제출</h3>
        <div class="submit-row">
          <input type="text" id="flagInput" placeholder="NL{flag_here}" />
          <button id="submitBtn">제출</button>
        </div>
        <div id="result-message"></div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const PROBLEM_DETAIL_API = id => `${window.API_BASE_URL}/submit/problems/${id}`;
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) { alert('문제 ID가 없습니다'); history.back(); return; }

      const token = localStorage.getItem('token');

      $.ajax({
        url: PROBLEM_DETAIL_API(id),
        method: 'GET',
        headers: token ? { 'Authorization': 'Bearer ' + token } : undefined,
        success: function (p) {
          $('#problem-title').text(p.title || `문제 ${id}`);
          $('#problem-content').text(p.description || '내용 없음');

          const levelText = (p.difficulty || 'NORMAL').toUpperCase();
          const levelElem = $('#problem-level');
          levelElem.text(levelText);

          levelElem.removeClass('difficulty-easy difficulty-normal difficulty-hard');
          if (levelText === 'EASY') levelElem.addClass('difficulty-easy');
          else if (levelText === 'NORMAL') levelElem.addClass('difficulty-normal');
          else if (levelText === 'HARD') levelElem.addClass('difficulty-hard');
        },
        error: function (xhr) {
          $('#problem-title').text('문제 로딩 실패');
          $('#problem-content').text(xhr.responseText || xhr.statusText || '에러');
        }
      });

      // ====== 다운로드 기능 ======
      document.getElementById("downloadBtn").addEventListener("click", function () {
        const token = localStorage.getItem("token");

        fetch(`${API_BASE_URL}/problems/${id}/download`, {
          headers: { "Authorization": "Bearer " + token }
        })
          .then(res => {
            if (!res.ok) throw new Error("다운로드 실패");
            return res.blob();
          })
          .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `problem_${id}.pka`;
            document.body.appendChild(a);
            a.click();
            a.remove();
          })
          .catch(() => alert("파일 다운로드에 실패했습니다."));
      });

      // ====== 플래그 제출 ======
      $('#submitBtn').on('click', function () {
        const flag = $('#flagInput').val().trim();
        const token = localStorage.getItem('token');
        if (!flag) return alert('플래그를 입력하세요');

        $.ajax({
          url: `${window.API_BASE_URL}/submit/${id}`,
          method: 'POST',
          contentType: 'application/json',
          headers: token ? { 'Authorization': 'Bearer ' + token } : undefined,
          data: JSON.stringify({ flag }),
          success: function (res) {
            const msgElem = $('#result-message');
            msgElem.removeClass('success fail');

            const successRaw =
              res && res.hasOwnProperty('isSuccess') ? res.isSuccess :
              res && res.hasOwnProperty('success') ? res.success :
              res && res.hasOwnProperty('result') ? res.result :
              false;

            let isCorrect = false;
            if (typeof successRaw === 'string') {
              isCorrect = successRaw.toLowerCase() === 'true';
            } else if (typeof successRaw === 'number') {
              isCorrect = successRaw === 1;
            } else {
              isCorrect = !!successRaw;
            }

            const serverMessage = res && (res.msg || res.message);
            const successMessage = serverMessage || '정답입니다! 🎉';
            const failureMessage = serverMessage || '틀렸습니다. 다시 시도해보세요.';

            if (isCorrect) {
              msgElem.addClass('success').text(successMessage);
              $('#flagInput').prop('disabled', true);
              $('#submitBtn').prop('disabled', true).text('제출 완료');

              //  폭죽 효과
              confetti({
                particleCount: 200,
                spread: 70,
                origin: { y: 0.6 }
              });

              confetti({
                particleCount: 120,
                angle: 60,
                spread: 55,
                origin: { x: 0, y: 0.6 }
              });
              confetti({
                particleCount: 120,
                angle: 120,
                spread: 55,
                origin: { x: 1, y: 0.6 }
              });

              // 2초간 연속 폭죽
              let duration = 2 * 1000;
              let end = Date.now() + duration;
              (function frame() {
                confetti({
                  particleCount: 5,
                  angle: 60,
                  spread: 55,
                  origin: { x: 0, y: 0.6 }
                });
                confetti({
                  particleCount: 5,
                  angle: 120,
                  spread: 55,
                  origin: { x: 1, y: 0.6 }
                });
                if (Date.now() < end) requestAnimationFrame(frame);
              })();
            } else {
              msgElem.addClass('fail').text(failureMessage);
            }
          },
          error: function (xhr) {
            $('#result-message')
              .removeClass('success fail')
              .addClass('fail')
              .text(xhr.responseText || '서버 오류가 발생했습니다.');
          }
        });
      });
    })();
  </script>
</body>

</html>

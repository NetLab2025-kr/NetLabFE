<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NetLab</title>

  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <link rel="stylesheet" href="../assets/css/main_style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- 기존 의존성 (그대로 유지) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
  <script type="module" src="../PUBLIC/JS/main.js"></script>
</head>

<body>
  <!-- ===== 네비바 전체 제거됨 ===== -->

  <!-- 기존 페이지 UI -->
  <div id="top-view">
    <div id="top-bar">
      <div id="tap">
        <button class="tap" id="problem">Problem</button>
        <button class="tap" id="cli">CLI</button>
        <button class="tap" id="topology">Topology</button>
      </div>

      <div id="bar">
        <!-- 문제 탭 -->
        <div id="problem-box">
          <div id="problem-head">
            <h1 id="problem-title">Problem 1 - Routing</h1>
            <h2 class="problem-level">easy</h2>
          </div>
          <div id="problem-content">로딩 중...</div>
        </div>

        <!-- topology 창 -->
        <div id="Device-box">
          <div id="device-change">
            <button class="device_change" id="nd">Network Device</button>
            <button class="device_change" id="ed">End Device</button>
            <button class="device_change" id="cn">Connection</button>
          </div>

          <div id="device-nd">
            <button class="tools" id="router" data-type="router">
              <img src="../assets/router.png" title="Router" draggable="false">
            </button>
            <button class="tools" id="switch" data-type="switch">
              <img src="../assets/switch.png" title="Switch" draggable="false">
            </button>
            <button class="tools" id="hub" data-type="hub">
              <img src="../assets/hub.png" title="Hub" draggable="false">
            </button>
          </div>

          <div id="device-ed">
            <button class="tools" id="pc">
              <img src="../assets/pc.png" title="PC" draggable="false">
            </button>
            <button class="tools" id="labtop">
              <img src="../assets/laptop.png" title="Labtop" draggable="false">
            </button>
            <button class="tools" id="server">
              <img src="../assets/fileserver.png" title="Server" draggable="false">
            </button>
          </div>

          <div id="device-cn">
            <button class="connections" id="console_line">
              <img src="/assets/console.png" title="Console" draggable="false">
            </button>
            <button class="connections" id="straight_line">
              <img src="/assets/direct.png" title="Copper Straight-Through" draggable="false">
            </button>
            <button class="connections" id="cross_line">
              <img src="/assets/cross_over.png" title="Copper Cross-over" draggable="false">
            </button>
            <button class="connections" id="fiver_line">
              <img src="/assets/fiber.png" title="Fiber" draggable="false">
            </button>
            <button class="connections" id="serial_line">
              <img src="/assets/serial.png" title="Serial DTE" draggable="false">
            </button>
          </div>
        </div>

        <!-- CLI 창 -->
        <div id="cli-container" style="display: none">
          <div class="cli-box">
            <div class="cli-output">
              <div class="cli-input-line">
                <span class="cli-prompt">Router&gt;</span>
                <input class="cli-input" type="text" autocomplete="off">
              </div>
            </div>
          </div>
        </div>

        <!-- ip 세팅 창(cli 없는 기기들) -->
        <div id="setting-container">
          <h3 class="setting-title"></h3>
          <div class="setting-box" style="display: none">
            <div class="ip">
              <p>IPv4</p>
              <input type="text">
            </div>
            <div class="subnet">
              <p>Subnet Mask</p>
              <input type="text">
            </div>
            <div class="gateway">
              <p>Default Gateway</p>
              <input type="text">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="background">
      <div id="topology-frame">
        <div id="topology-inner">
          <div id="IntContainer" style="display: none;">
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="bottom-view">
    <div id="time-about">
      <div id="time-left">
        <h5 id="time-shower">Time: 00:00:00</h5>
        <button id="tap-updown">Tap Down</button>
      </div>
      <div id="time-right">
        <button id="skip">skip</button>
        <button id="back">back</button>
      </div>
    </div>
  </div>

  <!-- 토큰 유지 + 관리자 확인만 남김 -->
  <script>
    (function () {
      const accessToken = localStorage.getItem('token');
      const refreshToken = localStorage.getItem('refreshToken');

      function checkAdmin(token) {
        $.ajax({
          url: "https://be.netlab.kr/api/auth/is-admin",
          method: "GET",
          headers: { "Authorization": "Bearer " + token }
        });
      }

      function setStoredName(n) { if (n) localStorage.setItem('name', n); }

      if (accessToken) {
        checkAdmin(accessToken);
      } else if (refreshToken) {
        $.ajax({
          url: 'https://be.netlab.kr/api/auth/refresh',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ refreshToken }),
          success: function (res) {
            localStorage.setItem('token', res.accessToken);
            localStorage.setItem('refreshToken', res.refreshToken);
            setStoredName(res.name);
            checkAdmin(res.accessToken);
          }
        });
      }
    })();

    // ====== 문제 상세 로딩 ======
    (function () {
      const PROBLEM_DETAIL_API = id => `https://be.netlab.kr/api/submit/problems/${id}`;
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) { alert('문제 ID가 없습니다'); history.back(); return; }

      const token = localStorage.getItem('token');

      $.ajax({
        url: PROBLEM_DETAIL_API(id),
        method: 'GET',
        headers: token ? { 'Authorization': 'Bearer ' + token } : undefined,
        success: function (p) {
          $('#problem-title').text(p.title || `Problem ${id}`);
          $('.problem-level').text(p.difficulty || '');
          $('#problem-content').text(p.description || '내용 없음');
        },
        error: function (xhr) {
          $('#problem-title').text('문제 로딩 실패');
          $('#problem-content').text(xhr.responseText || xhr.statusText || '에러');
        }
      });
    })();
  </script>
</body>

</html>


<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NetLab</title>

  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="../config.js"></script>

  <style>
    body {
      font-family: 'Pretendard';
      margin: 0;
      background: linear-gradient(135deg, #e6f0ff, #ffffff);
      color: #222;
    }

    #top-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 50px;
    }

    #problem-box {
      background: #f9fbff;
      box-shadow: 0 4px 10px rgba(0, 90, 255, 0.1);
      border-radius: 12px;
      padding: 40px;
      width: 700px;
      border: 1px solid #dce6ff;
    }

    #problem-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    #problem-title {
      font-size: 24px;
      color: #34b3ff;
      font-weight: 700;
    }

    .btn {
      background: #34b3ff;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn:hover {
      background: #34b3ff;
    }

    /* 난이도 표시 */
    .problem-level {
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 8px;
      text-transform: uppercase;
      font-size: 14px;
    }

    .difficulty-easy {
      background: #d9f9e5;
      color: #27b86d;
    }

    .difficulty-normal {
      background: #e5f1ff;
      color: #34b3ff;
    }

    .difficulty-hard {
      background: #ffe5e5;
      color: #ff5b5b;
    }

    #problem-content {
      font-size: 16px;
      margin-bottom: 40px;
      line-height: 1.6;
    }

    /* 플래그 제출창 */
    #submit-box {
      margin-top: 20px;
      background: #eef5ff;
      border-radius: 10px;
      padding: 25px;
      border: 1px solid #c8dfff;
    }

    #submit-box h3 {
      color: #34b3ff;
      margin-bottom: 15px;
      font-size: 18px;
    }

    #flagInput {
      width: 80%;
      padding: 10px;
      border: 1px solid #a8c6ff;
      border-radius: 6px;
      font-size: 15px;
    }

    #submitBtn {
      margin-left: 10px;
      background: #f89f3a;
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }

    #submitBtn:hover {
      background: #0040cc;
    }

    #result-message {
      margin-top: 15px;
      font-weight: 600;
      text-align: center;
    }

    .success {
      color: #007b0c;
    }

    .fail {
      color: #d80000;
    }
  </style>
</head>

<body>
  <div id="top-view">
    <div id="problem-box">
      <div id="problem-head">
        <h1 id="problem-title">문제 제목</h1>
        <button id="downloadBtn" class="btn">.pka 파일 다운로드</button>
        <h2 class="problem-level" id="problem-level">EASY</h2>
      </div>

      <div id="problem-content">로딩 중...</div>

      <!-- 플래그 제출창 -->
      <div id="submit-box">
        <h3>플래그 제출</h3>
        <input type="text" id="flagInput" placeholder="Sunrin{flag_here}" />
        <button id="submitBtn">제출</button>
        <div id="result-message"></div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const PROBLEM_DETAIL_API = id => `${window.API_BASE_URL}/submit/problems/${id}`;
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) { alert('문제 ID가 없습니다'); history.back(); return; }

      const token = localStorage.getItem('token');

      $.ajax({
        url: PROBLEM_DETAIL_API(id),
        method: 'GET',
        headers: token ? { 'Authorization': 'Bearer ' + token } : undefined,
        success: function (p) {
          $('#problem-title').text(p.title || `문제 ${id}`);
          $('#problem-content').text(p.description || '내용 없음');

          const levelText = (p.difficulty || 'NORMAL').toUpperCase();
          const levelElem = $('#problem-level');
          levelElem.text(levelText);

          // 난이도별 색상 클래스 적용
          levelElem.removeClass('difficulty-easy difficulty-normal difficulty-hard');
          if (levelText === 'EASY') levelElem.addClass('difficulty-easy');
          else if (levelText === 'NORMAL') levelElem.addClass('difficulty-normal');
          else if (levelText === 'HARD') levelElem.addClass('difficulty-hard');
        },
        error: function (xhr) {
          $('#problem-title').text('문제 로딩 실패');
          $('#problem-content').text(xhr.responseText || xhr.statusText || '에러');
        }
      });

      // ====== 다운로드 기능 ======
      document.getElementById("downloadBtn").addEventListener("click", function () {
        const token = localStorage.getItem("token");

        fetch(`${API_BASE_URL}/problems/${id}/download`, {
          headers: { "Authorization": "Bearer " + token }
        })
          .then(res => {
            if (!res.ok) throw new Error("다운로드 실패");
            return res.blob();
          })
          .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `problem_${id}.pka`;
            document.body.appendChild(a);
            a.click();
            a.remove();
          })
          .catch(() => alert("파일 다운로드에 실패했습니다."));
      });

      // ====== 플래그 제출 ======
      $('#submitBtn').on('click', function () {
        const flag = $('#flagInput').val().trim();
        const token = localStorage.getItem('token');
        if (!flag) return alert('플래그를 입력하세요');

        $.ajax({
          url: `${window.API_BASE_URL}/submit/${id}`,
          method: 'POST',
          contentType: 'application/json',
          headers: token ? { 'Authorization': 'Bearer ' + token } : undefined,
          data: JSON.stringify({ flag }),
          success: function (res) {
            $('#result-message')
              .removeClass('success fail')
              .addClass(res.correct ? 'success' : 'fail')
              .text(res.correct ? ' 정답입니다!' : ' 오답입니다.');
          },
          error: function () {
            $('#result-message')
              .removeClass('success fail')
              .addClass('fail')
              .text('서버 오류가 발생했습니다.');
          }
        });
      });
    })();
  </script>
</body>

</html>
